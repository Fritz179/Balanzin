let xOff,yOff,width;function assert(t,e){t||alert("Erur :-(\n"+e)}function log(...t){fritz.toLog&&console.log(...t)}function hasNetFlags(t){return t.netflag&&Object.keys(t.netflag).length}function getNamedNets(t,e){return hasNetFlags(t)?Object.keys(t.netflag).map(e=>t.netflag[e]).filter(t=>stripName(t.mark.netFlagString)==e).sort((t,e)=>t.mark.x-e.mark.x):[]}function getNewName(t){if(!t)return"";const e=t=>Math.ceil((t-10)/195);return`${t.page}.${(t=>String.fromCharCode(64+t))(e(t.mark.y-yOff))}/${e(t.mark.x-xOff)}`}const linkReg=/\(.*?\)/;function stripName(t){return t.replace(linkReg,"").trim()}function rename(t,e,n){const a=stripName(t.mark.netFlagString),r=getNewName(e),i=getNewName(n),o=`${a} (${r+(r&&i?", ":r||i?"":"???")+i})`;t.mark.netFlagString!=o&&(console.log(`renaming: '${t.mark.netFlagString}' to: '${o}'`),t.mark.netFlagString=o,api("updateShape",{shapeType:"netflag",jsonCache:{gId:t.configure.gId,mark:t.mark}}))}function addPageNumber(t,e){const n=getAnn(e.json,"frame_title").string,a=n.match(/curr: ([0-9]*)?,/),r=a?+a[1]:-1;return e.page=r,assert(!t[n],"2 pagini cun al stes titul?"),t[n]=e.tabid,e}function getAnn(t,e){for(name in t.schlib.frame_lib_1.annotation){const n=t.schlib.frame_lib_1.annotation[name];if(n.c_etype==e)return n}}function getJSONS(){const t={},e=api("getSource",{type:"json"}),n=api("getAllJson",{type:"json"}).map(e=>addPageNumber(t,e)).sort((t,e)=>t.page-e.page),a=e.head.uuid||t[getAnn(e,"frame_title").string];let r=-1;assert(a,"nisün id??"),xOff=e.BBox.x,yOff=e.BBox.y;for(let t=0;t<n.length;t++)if(n[t].tabid==a){r=t;break}return assert(-1!=r,"Invalid page?"),-1==n[r].page&&(n[r].page=n[n.length-1].page+1,n.sort((t,e)=>t.page-e.page),r=n.length-1),[n,e,r]}function run(){const[t,e,n]=getJSONS(),a=n+1<t.length?`next: ${t[n+1].page}`:"l'ültim",r=`curr: ${t[n].page}, ${a}`,i=getAnn(e,"frame_title");if(i.string!=r&&(console.log(`retitling: '${i.string}' to: '${r}'`),i.string=r,api("applySource",{source:e,createNew:!1})),!hasNetFlags(e))return;const o=[...new Set(Object.keys(e.netflag).map(t=>stripName(e.netflag[t].mark.netFlagString)))],l={},g={};return log("to crawl:",o),o.forEach(a=>{log("crawling: ",a);for(let e=n-1;e>=0;e--){const n=getNamedNets(t[e].json,a);if(n.length){l[a]=n[0],l[a].page=t[e].page;break}}for(let e=n+1;e<t.length;e++){const n=getNamedNets(t[e].json,a);if(n.length){g[a]=n[n.length-1],g[a].page=t[e].page;break}}const r=getNamedNets(e,a);assert(r.length,"impusibal"),1==r.length?rename(r[0],l[a],g[a]):(rename(r[0],l[a],null),rename(r[r.length-1],null,g[a]))}),0}function start(){try{run(),fritz.autoRun||console.warn("fritz.autoRun is false, use run() for single execution")}catch(t){fritz.autoRun=!1,console.error(t),alert("Erur, fritz.autoRun le disabiltu")}finally{fritz.autoRun&&setTimeout(start,fritz.delay)}}const fritz=window.fritz={toLog:!0,autoRun:!0,delay:1e3,run:run,start:start,api:api,autoStart:()=>{autoRun=!0,start()}};function changePage(t){const[e,n,a]=getJSONS(),r=a+t;if(r<0||r>=e.length)return void alert("le l'ultima pagina...");const i=e[r].tabid,o=document.querySelector(`[node-id="${i}"] .tree-title`);log(`navigating from:\n    [${e[a].page}, ${e[a].title}, ${a}] to:\n    [${e[r].page}, ${e[r].title}, ${r}]\n  `),o.click();const l=new MouseEvent("dblclick",{view:window,bubbles:!0,cancelable:!0});o.dispatchEvent(l)}function keyListener(t){try{t.altKey&&("ArrowRight"==t.key?(changePage(1),t.preventDefault()):"ArrowLeft"==t.key?(changePage(-1),t.preventDefault()):"ArrowUp"==t.key&&(fritz.autoRun=!fritz.autoRun,fritz.autoRun&&fritz.start(),console.log(`fritz autoRun: ${fritz.autoRun}`)))}catch(t){alert("erur"),console.log(t)}}start(),window.addEventListener("keydown",t=>keyListener(t),!0),setInterval(()=>{document.querySelectorAll("iframe").forEach(t=>{t.contentWindow.hasFritzListener||(t.contentWindow.addEventListener("keydown",t=>keyListener(t),!0),t.contentWindow.hasFritzListener=!0)})},1e3);
